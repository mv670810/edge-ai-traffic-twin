<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Traffic Digital Twin</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: monospace; }
        #info { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #444; }
        h1 { margin: 0; font-size: 18px; color: #00ff00; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>
<body>
    <div id="info">
        <h1>Traffic Digital Twin (Edge AI)</h1>
        <p>Status: <span id="status" style="color: red">Disconnected</span></p>
        <p>Objects: <span id="obj-count">0</span></p>
        <p>FPS: <span id="fps">0</span></p>
    </div>

    <script>
        // --- 1. Three.js 3D 場景初始化 ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x101010); // 深色背景
        scene.fog = new THREE.Fog(0x101010, 20, 100);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 40, 40); // 攝影機架在右上角俯視
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 地板網格 (Grid)
        const gridHelper = new THREE.GridHelper(60, 60, 0x00ff00, 0x333333);
        scene.add(gridHelper);

        // 燈光
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        // 儲存目前的 3D 物件 (車輛/行人)
        let currentObjects = [];

        // --- 2. 輔助函式：建立 3D 物件 ---
        function create3DObject(id, classId, x, y) {
            // 將 2D 像素座標 (0~640) 映射到 3D 世界座標 (-30 ~ +30)
            const mapX = (x / 640) * 60 - 30;
            const mapZ = (y / 640) * 60 - 30;

            let geometry, material, mesh;

            if (classId === 2) { // Car (Blue Cube)
                geometry = new THREE.BoxGeometry(2, 2, 4);
                material = new THREE.MeshLambertMaterial({ color: 0x0088ff });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(mapX, 1, mapZ); // y=1 讓它在地板上
            } else { // Person (Red Cylinder)
                geometry = new THREE.CylinderGeometry(0.5, 0.5, 1.8, 16);
                material = new THREE.MeshLambertMaterial({ color: 0xff3333 });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(mapX, 0.9, mapZ);
            }
            scene.add(mesh);
            return mesh;
        }

        function clearObjects() {
            currentObjects.forEach(obj => scene.remove(obj));
            currentObjects = [];
        }

        // --- 3. MQTT 連線邏輯 ---
        const client = new Paho.MQTT.Client("localhost", 9001, "web_client_" + new Date().getTime());

        client.onConnectionLost = (responseObject) => {
            document.getElementById("status").innerText = "Disconnected";
            document.getElementById("status").style.color = "red";
        };

        client.onMessageArrived = (message) => {
            // 收到 AI 傳來的 JSON
            const payload = JSON.parse(message.payloadString);
            const objects = payload.objs;

            // 更新 UI
            document.getElementById("obj-count").innerText = objects.length;
            // 簡單估算傳輸間隔當作 FPS (僅供參考)
            document.getElementById("fps").innerText = "Active"; 

            // 清除舊位置，繪製新位置 (簡易實作，進階可用插值移動)
            clearObjects();

            objects.forEach(obj => {
                // obj.c = class, obj.x/y = coordinates
                const mesh = create3DObject(null, obj.c, obj.x, obj.y);
                currentObjects.push(mesh);
            });
        };

        // 開始連線
        client.connect({
            onSuccess: () => {
                document.getElementById("status").innerText = "Connected (Live)";
                document.getElementById("status").style.color = "#00ff00";
                client.subscribe("traffic/sensor1");
            },
            onFailure: (e) => {
                console.log(e);
                document.getElementById("status").innerText = "Failed";
            }
        });

        // --- 4. 渲染迴圈 ---
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // RWD 調整
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
